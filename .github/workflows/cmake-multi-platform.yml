name: Geode Mod Build

on:
  workflow_dispatch:

jobs:
  android:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        abi: [arm64-v8a, armeabi-v7a]

    steps:
      - uses: actions/checkout@v4
      - uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26d

      - name: Build Android (${{ matrix.abi }})
        run: |
          mkdir build-${{ matrix.abi }}
          cd build-${{ matrix.abi }}
          cmake .. \
            -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=${{ matrix.abi }} \
            -DANDROID_PLATFORM=android-21 \
            -DCMAKE_BUILD_TYPE=Release
          cmake --build . --config Release
          cd ..
          if [ "${{ matrix.abi }}" = "arm64-v8a" ]; then
            cp build-${{ matrix.abi }}/libvideo_importer.so xx0wq.video.importer.android64.so
          else
            cp build-${{ matrix.abi }}/libvideo_importer.so xx0wq.video.importer.android32.so
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: geode-android-${{ matrix.abi }}
          path: xx0wq.video.importer.android*.so

  windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build Windows
        run: |
          mkdir build-win64
          cd build-win64
          cmake .. -A x64 -DCMAKE_BUILD_TYPE=Release
          cmake --build . --config Release
          cd ..
          copy build-win64\\Release\\video_importer.dll xx0wq.video.importer.win64.dll

      - uses: actions/upload-artifact@v4
        with:
          name: geode-win64
          path: xx0wq.video.importer.win64.dll

  macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build macOS
        run: |
          mkdir build-macos
          cd build-macos
          cmake .. -DCMAKE_BUILD_TYPE=Release
          make -j$(sysctl -n hw.ncpu)
          cd ..
          cp build-macos/libvideo_importer.dylib xx0wq.video.importer.macos.dylib

      - uses: actions/upload-artifact@v4
        with:
          name: geode-macos
          path: xx0wq.video.importer.macos.dylib

  ios:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build iOS (arm64)
        run: |
          mkdir build-ios
          cd build-ios
          cmake .. \
            -DCMAKE_TOOLCHAIN_FILE=$PWD/ios.toolchain.cmake \
            -DPLATFORM=OS64 \
            -DCMAKE_BUILD_TYPE=Release
          make -j$(sysctl -n hw.ncpu)
          cd ..
          cp build-ios/libvideo_importer.dylib xx0wq.video.importer.ios.dylib

      - uses: actions/upload-artifact@v4
        with:
          name: geode-ios
          path: xx0wq.video.importer.ios.dylib
