name: Geode Mod Build & Release (No CMake, Patched Mobile)

permissions:
  contents: write

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  CXX_STD: c++20

jobs:
  build-android:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        abi: [arm64-v8a, armeabi-v7a]
    steps:
      - uses: actions/checkout@v4

      - name: Fetch Geode SDK headers + Enums.hpp
        run: |
          git clone --depth=1 https://github.com/geode-sdk/geode.git geode-sdk
          git clone --depth=1 https://github.com/geode-sdk/bindings.git geode-bindings
          mkdir -p include/Geode
          cp -r geode-sdk/loader/include/Geode/* include/Geode/
          cp geode-bindings/bindings/include/Geode/Enums.hpp include/Geode/

      - name: Patch Geode headers to guard cocos includes
        run: |
          # Guard cocos-ext in addresser.hpp
          sed -i 's|#include <cocos-ext.h>|#if !defined(GEODE_PLATFORM_ANDROID) && !defined(GEODE_PLATFORM_IOS)\n#include <cocos-ext.h>\n#endif|' include/Geode/utils/addresser.hpp

          # Guard cocos-ext + cocos2d in Bindings.hpp
          awk '
            /#include <cocos-ext.h>/ {print "#if !defined(GEODE_PLATFORM_ANDROID) && !defined(GEODE_PLATFORM_IOS)"; print "#include <cocos-ext.h>"; next}
            /#include <cocos2d.h>/   {print "#include <cocos2d.h>"; print "#endif"; next}
            {print}
          ' include/Geode/Bindings.hpp > include/Geode/Bindings.hpp.tmp && mv include/Geode/Bindings.hpp.tmp include/Geode/Bindings.hpp

      - uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26d

      - name: Build Android ${{ matrix.abi }}
        run: |
          mkdir -p build
          $ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/clang++ \
            -std=${{ env.CXX_STD }} \
            -DGEODE_PLATFORM_ANDROID=1 \
            -DGEODE_DLL= \
            -DVIDEO_IMPORTER_NO_FFMPEG=1 \
            -DVIDEO_IMPORTER_NO_COCOS=1 \
            -I include \
            -fPIC -shared src/*.cpp \
            -o build/xx0wq.video.importer.${{ matrix.abi == 'arm64-v8a' && 'android64' || 'android32' }}.so

      - uses: actions/upload-artifact@v4
        with:
          name: android-${{ matrix.abi }}-binary
          path: build/xx0wq.video.importer.android*.so

  build-ios:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Fetch Geode SDK headers + Enums.hpp
        run: |
          git clone --depth=1 https://github.com/geode-sdk/geode.git geode-sdk
          git clone --depth=1 https://github.com/geode-sdk/bindings.git geode-bindings
          mkdir -p include/Geode
          cp -r geode-sdk/loader/include/Geode/* include/Geode/
          cp geode-bindings/bindings/include/Geode/Enums.hpp include/Geode/

      - name: Patch Geode headers to guard cocos includes
        run: |
          sed -i '' 's|#include <cocos-ext.h>|#if !defined(GEODE_PLATFORM_ANDROID) && !defined(GEODE_PLATFORM_IOS)\n#include <cocos-ext.h>\n#endif|' include/Geode/utils/addresser.hpp

          awk '
            /#include <cocos-ext.h>/ {print "#if !defined(GEODE_PLATFORM_ANDROID) && !defined(GEODE_PLATFORM_IOS)"; print "#include <cocos-ext.h>"; next}
            /#include <cocos2d.h>/   {print "#include <cocos2d.h>"; print "#endif"; next}
            {print}
          ' include/Geode/Bindings.hpp > include/Geode/Bindings.hpp.tmp && mv include/Geode/Bindings.hpp.tmp include/Geode/Bindings.hpp

      - name: Build iOS dylib
        run: |
          mkdir -p build
          clang++ -std=${{ env.CXX_STD }} \
            -DGEODE_PLATFORM_IOS=1 \
            -DGEODE_DLL= \
            -DVIDEO_IMPORTER_NO_FFMPEG=1 \
            -DVIDEO_IMPORTER_NO_COCOS=1 \
            -I include \
            -fPIC -shared src/*.cpp \
            -o build/xx0wq.video.importer.ios.dylib

      - uses: actions/upload-artifact@v4
        with:
          name: ios-binary
          path: build/xx0wq.video.importer.ios.dylib
