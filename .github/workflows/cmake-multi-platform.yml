name: Geode Mod Build & Release (No CMake, Resilient Mobile)

permissions:
  contents: write

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  # Compiler feature flags shared across jobs
  CXX_STD: c++20

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Fetch Geode SDK headers + Enums.hpp
        shell: bash
        run: |
          set -e
          git clone --depth=1 https://github.com/geode-sdk/geode.git geode-sdk
          git clone --depth=1 https://github.com/geode-sdk/bindings.git geode-bindings
          mkdir -p include/Geode
          cp -r geode-sdk/loader/include/Geode/* include/Geode/
          cp geode-bindings/bindings/include/Geode/Enums.hpp include/Geode/
          test -f include/Geode/Enums.hpp
          test -f include/Geode/Bindings.hpp
          test -f include/Geode/c++stl/string.hpp

      - name: Setup MSVC Dev Command Prompt
        uses: ilammy/msvc-dev-cmd@v1

      - name: Build Windows DLL (MSVC)
        shell: cmd
        run: |
          if not exist build mkdir build
          setlocal enabledelayedexpansion
          set SRC=
          for %%f in (src\*.cpp) do set SRC=!SRC! "%%f"
          rem Desktop: enable FFmpeg, keep GEODE_DLL as normal
          cl /EHsc /std:%CXX_STD% /DGEODE_PLATFORM_WINDOWS=1 /MD ^
            /I include ^
            %SRC% ^
            /LD /link /OUT:build\xx0wq.video.importer.win64.dll

      - uses: actions/upload-artifact@v4
        with:
          name: win64-binary
          path: build/xx0wq.video.importer.win64.dll

  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install FFmpeg (macOS)
        run: brew install ffmpeg

      - name: Fetch Geode SDK headers + Enums.hpp
        run: |
          set -e
          git clone --depth=1 https://github.com/geode-sdk/geode.git geode-sdk
          git clone --depth=1 https://github.com/geode-sdk/bindings.git geode-bindings
          mkdir -p include/Geode
          cp -r geode-sdk/loader/include/Geode/* include/Geode/
          cp geode-bindings/bindings/include/Geode/Enums.hpp include/Geode/
          test -f include/Geode/Enums.hpp
          test -f include/Geode/Bindings.hpp
          test -f include/Geode/c++stl/string.hpp

      - name: Build macOS dylib
        run: |
          mkdir -p build
          clang++ -std=${{ env.CXX_STD }} -DGEODE_PLATFORM_MACOS=1 \
            -I include \
            -dynamiclib src/*.cpp -o build/xx0wq.video.importer.macos.dylib

      - uses: actions/upload-artifact@v4
        with:
          name: macos-binary
          path: build/xx0wq.video.importer.macos.dylib

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install FFmpeg dev libs (Linux)
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg pkg-config libavcodec-dev libavformat-dev libavutil-dev libswscale-dev

      - name: Fetch Geode SDK headers + Enums.hpp
        run: |
          set -e
          git clone --depth=1 https://github.com/geode-sdk/geode.git geode-sdk
          git clone --depth=1 https://github.com/geode-sdk/bindings.git geode-bindings
          mkdir -p include/Geode
          cp -r geode-sdk/loader/include/Geode/* include/Geode/
          cp geode-bindings/bindings/include/Geode/Enums.hpp include/Geode/
          test -f include/Geode/Enums.hpp
          test -f include/Geode/Bindings.hpp
          test -f include/Geode/c++stl/string.hpp

      - name: Build Linux .so
        run: |
          mkdir -p build
          clang++ -std=${{ env.CXX_STD }} -DGEODE_PLATFORM_LINUX=1 \
            -I include \
            -fPIC -shared src/*.cpp \
            -o build/xx0wq.video.importer.linux.so

      - uses: actions/upload-artifact@v4
        with:
          name: linux-binary
          path: build/xx0wq.video.importer.linux.so

  build-android:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        abi: [arm64-v8a, armeabi-v7a]
    steps:
      - uses: actions/checkout@v4

      - name: Fetch Geode SDK headers + Enums.hpp
        run: |
          set -e
          git clone --depth=1 https://github.com/geode-sdk/geode.git geode-sdk
          git clone --depth=1 https://github.com/geode-sdk/bindings.git geode-bindings
          mkdir -p include/Geode
          cp -r geode-sdk/loader/include/Geode/* include/Geode/
          cp geode-bindings/bindings/include/Geode/Enums.hpp include/Geode/
          test -f include/Geode/Enums.hpp
          test -f include/Geode/Bindings.hpp
          test -f include/Geode/c++stl/string.hpp

      - uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26d

      - name: Build Android ${{ matrix.abi }} (FFmpeg & Cocos disabled)
        run: |
          mkdir -p build
          $ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/clang++ \
            -std=${{ env.CXX_STD }} \
            -DGEODE_PLATFORM_ANDROID=1 \
            -DGEODE_DLL= \
            -DVIDEO_IMPORTER_NO_FFMPEG=1 \
            -DVIDEO_IMPORTER_NO_COCOS=1 \
            -I include \
            -fPIC -shared src/*.cpp \
            -o build/xx0wq.video.importer.${{ matrix.abi == 'arm64-v8a' && 'android64' || 'android32' }}.so

      - uses: actions/upload-artifact@v4
        with:
          name: android-${{ matrix.abi }}-binary
          path: build/xx0wq.video.importer.android*.so

  build-ios:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Fetch Geode SDK headers + Enums.hpp
        run: |
          set -e
          git clone --depth=1 https://github.com/geode-sdk/geode.git geode-sdk
          git clone --depth=1 https://github.com/geode-sdk/bindings.git geode-bindings
          mkdir -p include/Geode
          cp -r geode-sdk/loader/include/Geode/* include/Geode/
          cp geode-bindings/bindings/include/Geode/Enums.hpp include/Geode/
          test -f include/Geode/Enums.hpp
          test -f include/Geode/Bindings.hpp
          test -f include/Geode/c++stl/string.hpp

      - name: Build iOS dylib (FFmpeg & Cocos disabled)
        run: |
          mkdir -p build
          clang++ -std=${{ env.CXX_STD }} \
            -DGEODE_PLATFORM_IOS=1 \
            -DGEODE_DLL= \
            -DVIDEO_IMPORTER_NO_FFMPEG=1 \
            -DVIDEO_IMPORTER_NO_COCOS=1 \
            -I include \
            -fPIC -shared src/*.cpp \
            -o build/xx0wq.video.importer.ios.dylib

      - uses: actions/upload-artifact@v4
        with:
          name: ios-binary
          path: build/xx0wq.video.importer.ios.dylib

  package:
    needs: [build-windows, build-macos, build-linux, build-android, build-ios]
    runs-on: ubuntu-latest
    outputs:
      mod_version: ${{ steps.get_version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
      - name: Create dist folder
        run: mkdir -p dist
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
      - name: Get version from mod.json
        id: get_version
        run: |
          VERSION=$(jq -r '.version' mod.json)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Detected mod version: $VERSION"
      - name: Create dist/final folder
        run: mkdir -p dist/final
      - name: Package binaries and resources
        run: |
          cp mod.json dist/
          cp -r resources dist/
          cd dist
          zip -r final/video_importer.zip mod.json resources xx0wq.video.importer.*.*
          cp final/video_importer.zip final/xx0wq.video.importer.geode
      - name: Generate checksums
        run: |
          cd dist/final
          sha256sum video_importer.zip > video_importer.zip.sha256
          sha256sum xx0wq.video_importer.geode > xx0wq.video_importer.geode.sha256
          echo "## SHA256 Checksums" > checksums.txt
          echo "\n**video_importer.zip**" >> checksums.txt
          cat video_importer.zip.sha256 >> checksums.txt
          echo "\n**xx0wq.video_importer.geode**" >> checksums.txt
          cat xx0wq.video_importer.geode.sha256 >> checksums.txt
      - uses: actions/upload-artifact@v4
        with:
          name: video_importer-package
          path: dist/final/*

  release:
    needs: package
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: video_importer-package
          path: dist/final
      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.package.outputs.mod_version }}
          name: Release v${{ needs.package.outputs.mod_version }}
          files: |
            dist/final/xx0wq.video_importer.geode
            dist/final/xx0wq.video_importer.geode.sha256
            dist/final/video_importer.zip
            dist/final/video_importer.zip.sha256
          body_path: dist/final/checksums.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
