name: Build Geode Mod (Windows)

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup MSVC
        uses: microsoft/setup-msbuild@v1.1

      - name: Install Scoop
        shell: powershell
        run: |
          Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser -Force
          Invoke-RestMethod -Uri https://get.scoop.sh | Invoke-Expression
          echo "$HOME\scoop\shims" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Install Geode CLI via Scoop
        shell: powershell
        run: |
          scoop bucket add extras
          scoop install geode-sdk-cli

      - name: Download Geometry Dash
        shell: powershell
        run: |
          $tempPath = "$env:RUNNER_TEMP\gd"
          New-Item -ItemType Directory -Path $tempPath -Force
          Invoke-WebRequest -Uri "https://download1338.mediafire.com/210q5ryy7p9gv07z5tLlzs2zoBmO-DqlrEtRXFAZohpIK66ILTuZL-rpcTgi7N28nzTYWqDbARW1fqFu-oPMRW396-Hg6dVKozVl2pcUDNii3Zg5PqX_yjChmte0c2Hyk1j725ik5DcHanpe0ghC_8kHMAqC7iBdNe3Dh7jvzozpzdPp/vs6ob9x2ozfbed0/Geometry.Dash.zip" -OutFile "$tempPath\GeometryDash.zip"
          Expand-Archive -Path "$tempPath\GeometryDash.zip" -DestinationPath $tempPath
          $gdExe = Get-ChildItem $tempPath -Recurse -Filter "GeometryDash.exe" | Select-Object -First 1
          echo "GD extracted to $($gdExe.FullName)"

      - name: Setup Geode Profile
        shell: powershell
        run: |
          $gdExe = Get-ChildItem "$env:RUNNER_TEMP\gd" -Recurse -Filter "GeometryDash.exe" | Select-Object -First 1
          $profile = @{
            profiles = @(
              @{
                name      = "default"
                developer = "xx0wq"
                platform  = "win"
                path      = $gdExe.FullName
              }
            )
          } | ConvertTo-Json -Depth 3
          $profile | Out-File -FilePath "$HOME\.geode\config.json" -Encoding utf8
          echo "Geode profile created at $HOME\.geode\config.json"

      - name: Install Geode SDK
        shell: powershell
        run: geode sdk install

      - name: Build Mod
        shell: powershell
        run: geode build

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: geode-mod
          path: build/*