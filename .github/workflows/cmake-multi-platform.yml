- name: Fetch Geode SDK headers (online first, local fallback for Enums)
  run: |
    set -e
    SDK_SRC="loader/include/Geode"

    echo "Attempting to download Geode SDK headers..."
    if git clone --depth=1 https://github.com/geode-sdk/geode.git tmp_geode; then
      if [ -d "tmp_geode/${SDK_SRC}" ]; then
        rm -rf setup/include/Geode
        cp -r "tmp_geode/${SDK_SRC}" setup/include/
        echo "Downloaded headers copied to setup/include/Geode"
      else
        echo "Online repo missing ${SDK_SRC}, falling back to local repo headers."
      fi
      rm -rf tmp_geode
    else
      echo "Download failed. Falling back to local repo headers."
    fi

    # If Enums.hpp is missing after download, copy from your repo
    if [ ! -f "setup/include/Geode/Enums.hpp" ] && [ -f ".github/backup/Enums.hpp" ]; then
      echo "Enums.hpp missing from online SDK, copying from repo backup..."
      cp ".github/backup/Enums.hpp" setup/include/Geode/Enums.hpp
    elif [ ! -f "setup/include/Geode/Enums.hpp" ] && [ -f "setup/include/Geode/enums.hpp" ]; then
      echo "Using lowercase enums.hpp as fallback."
      cp "setup/include/Geode/enums.hpp" setup/include/Geode/Enums.hpp
    fi

    # Verify critical files
    for f in "Enums.hpp" "platform/cplatform.h" "c++stl/gdstdlib.hpp"; do
      if [ ! -f "setup/include/Geode/$f" ]; then
        echo "Missing critical header: $f"
        exit 1
      fi
    done

    echo "Header check passed."
    ls -1 setup/include/Geode | head -n 20
