name: Geode Mod Build & Release

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'   # e.g. v0.7.0, v0.7.1

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform: [windows, macos, android64, android32, ios]
    steps:
      - uses: actions/checkout@v4

      - name: Set version in mod.json
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          if [[ "$VERSION" == "$GITHUB_REF_NAME" ]]; then VERSION="0.7.0"; fi
          echo "Using version: $VERSION"
          jq --arg ver "$VERSION" '.version = $ver' mod.json > mod.json.tmp && mv mod.json.tmp mod.json

      - name: Build ${{ matrix.platform }}
        run: |
          mkdir build
          cd build
          case "${{ matrix.platform }}" in
            windows)
              cmake .. -A x64
              cmake --build . --config Release
              cp Release/*.dll ../xx0wq.video.importer.win64.dll
              ;;
            macos)
              cmake .. -DCMAKE_BUILD_TYPE=Release
              cmake --build . --config Release
              cp *.dylib ../xx0wq.video.importer.macos.dylib
              ;;
            android64)
              cmake .. \
                -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake \
                -DANDROID_ABI=arm64-v8a \
                -DANDROID_PLATFORM=android-21 \
                -DCMAKE_BUILD_TYPE=Release
              cmake --build . --config Release
              cp *.so ../xx0wq.video.importer.android64.so
              ;;
            android32)
              cmake .. \
                -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake \
                -DANDROID_ABI=armeabi-v7a \
                -DANDROID_PLATFORM=android-21 \
                -DCMAKE_BUILD_TYPE=Release
              cmake --build . --config Release
              cp *.so ../xx0wq.video.importer.android32.so
              ;;
            ios)
              curl -L https://raw.githubusercontent.com/leetal/ios-cmake/master/ios.toolchain.cmake -o ios.toolchain.cmake
              cmake .. \
                -DCMAKE_TOOLCHAIN_FILE=../ios.toolchain.cmake \
                -DPLATFORM=OS64 \
                -DCMAKE_BUILD_TYPE=Release
              cmake --build . --config Release
              cp *.dylib ../xx0wq.video.importer.ios.dylib
              ;;
          esac

      - uses: actions/upload-artifact@v4
        with:
          name: binaries
          path: xx0wq.video.importer.*

  package:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: binaries
          path: dist

      - name: Create packages
        run: |
          mkdir dist/final
          cp mod.json dist/
          cp -r resources dist/
          cd dist
          zip -r final/video_importer.zip mod.json resources xx0wq.video.importer.*.*
          cp final/video_importer.zip final/xx0wq.video.importer.geode

      - name: Generate checksums
        run: |
          cd dist/final
          sha256sum video_importer.zip > video_importer.zip.sha256
          sha256sum xx0wq.video.importer.geode > xx0wq.video.importer.geode.sha256
          echo "## SHA256 Checksums" > checksums.txt
          echo "\n**video_importer.zip**" >> checksums.txt
          cat video_importer.zip.sha256 >> checksums.txt
          echo "\n**xx0wq.video.importer.geode**" >> checksums.txt
          cat xx0wq.video.importer.geode.sha256 >> checksums.txt

      - uses: actions/upload-artifact@v4
        with:
          name: video_importer-package
          path: dist/final/*

  release:
    needs: package
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: video_importer-package
          path: dist/final

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/final/xx0wq.video.importer.geode
            dist/final/xx0wq.video.importer.geode.sha256
          body_path: dist/final/checksums.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
