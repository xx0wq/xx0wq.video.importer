name: Geode Mod Build & Release

on:
  push:        # runs on every push
    branches:
      - main   # adjust if your default branch is different
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build Windows
        run: |
          mkdir build
          cd build
          cmake .. -G "Visual Studio 17 2022" -A x64
          cmake --build . --config Release
          cp Release/*.dll ../xx0wq.video.importer.win64.dll
      - uses: actions/upload-artifact@v4
        with:
          name: win64-binary
          path: xx0wq.video.importer.win64.dll

  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build macOS
        run: |
          mkdir build
          cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release
          cmake --build . --config Release
          cp *.dylib ../xx0wq.video.importer.macos.dylib
      - uses: actions/upload-artifact@v4
        with:
          name: macos-binary
          path: xx0wq.video.importer.macos.dylib

  build-android:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        abi: [arm64-v8a, armeabi-v7a]
    steps:
      - uses: actions/checkout@v4
      - uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26d
      - name: Build Android ${{ matrix.abi }}
        run: |
          mkdir build
          cd build
          cmake .. \
            -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=${{ matrix.abi }} \
            -DANDROID_PLATFORM=android-21 \
            -DCMAKE_BUILD_TYPE=Release
          cmake --build . --config Release
          cp *.so ../xx0wq.video.importer.${{ matrix.abi == 'arm64-v8a' && 'android64' || 'android32' }}.so
      - uses: actions/upload-artifact@v4
        with:
          name: android-${{ matrix.abi }}-binary
          path: xx0wq.video.importer.android*.so

  build-ios:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - name: Fetch iOS toolchain
        run: curl -L https://raw.githubusercontent.com/leetal/ios-cmake/master/ios.toolchain.cmake -o ios.toolchain.cmake
      - name: Build iOS
        run: |
          mkdir build
          cd build
          cmake .. \
            -DCMAKE_TOOLCHAIN_FILE=$PWD/../ios.toolchain.cmake \
            -DPLATFORM=OS64 \
            -DCMAKE_BUILD_TYPE=Release
          cmake --build . --config Release
          cp *.dylib ../xx0wq.video.importer.ios.dylib
      - uses: actions/upload-artifact@v4
        with:
          name: ios-binary
          path: xx0wq.video.importer.ios.dylib

  package:
    needs: [build-windows, build-macos, build-android, build-ios]
    runs-on: ubuntu-latest
    outputs:
      mod_version: ${{ steps.get_version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
      - name: Create dist folder
        run: mkdir -p dist

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Get version from mod.json
        id: get_version
        run: |
          VERSION=$(jq -r '.version' mod.json)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Validate binaries
        run: |
          echo "Checking for expected binaries..."
          ls dist || echo "dist folder missing"
          ls dist/* || echo "No binaries found"
          ls dist/xx0wq.video.importer.* || echo "Some binaries may be missing"

      - name: Create dist/final folder
        run: mkdir -p dist/final

      - name: Create packages
        run: |
          cp mod.json dist/
          cp -r resources dist/
          cp -r .github/workflows dist/workflows/
          cd dist
          zip -r final/video_importer.zip mod.json resources workflows xx0wq.video.importer.*.*
          cp final/video_importer.zip final/xx0wq.video.importer.geode

      - name: Generate checksums
        run: |
          cd dist/final
          sha256sum video_importer.zip > video_importer.zip.sha256
          sha256sum xx0wq.video.importer.geode > xx0wq.video.importer.geode.sha256
          echo "## SHA256 Checksums" > checksums.txt
          echo "\n**video_importer.zip**" >> checksums.txt
          cat video_importer.zip.sha256 >> checksums.txt
          echo "\n**xx0wq.video.importer.geode**" >> checksums.txt
          cat xx0wq.video.importer.geode.sha256 >> checksums.txt

      - uses: actions/upload-artifact@v4
        with:
          name: video_importer-package
          path: dist/final/*

  release:
    needs: package
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: video_importer-package
          path: dist/final

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.package.outputs.mod_version }}
          name: Release v${{ needs.package.outputs.mod_version }}
          files: |
            dist/final/xx0wq.video.importer.geode
            dist/final/xx0wq.video.importer.geode.sha256
          body_path: dist/final/checksums.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
